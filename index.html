<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Web-based OpenSCAD customizer - customize and generate 3D printable STL files directly in your browser" />
    <title>OpenSCAD Web Customizer</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#f4c400" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#0b0b0b" media="(prefers-color-scheme: dark)" />
    
    <!-- Mobile Web App -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="OpenSCAD Forge" />
    <link rel="apple-touch-icon" href="/icons/logo.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/icons/logo.png" />
    
    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#f4c400" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
  </head>
  <body>
    <!-- Skip to content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="app">
      <header class="app-header">
        <div class="header-content">
          <div class="header-branding">
            <img
              class="header-logo"
              src="/icons/logo.png"
              alt="OpenSCAD Assistive Web Forge logo"
              width="44"
            />
            <div class="header-branding-text">
              <h1>OpenSCAD Web Customizer</h1>
              <p class="app-tagline">Customize 3D models directly in your browser</p>
            </div>
          </div>
          <div class="header-controls">
            <a href="https://github.com/BrennenJohnston/openscad-web-customizer-forge" 
               class="github-link" 
               target="_blank" 
               rel="noopener noreferrer" 
               aria-label="View source code on GitHub (opens in new tab)" 
               title="View on GitHub">
              <svg class="github-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              <span class="github-label">GitHub</span>
            </a>
            <button id="contrastToggle" class="contrast-toggle" aria-label="Toggle high contrast" title="Toggle high contrast mode">
              <svg class="contrast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2 L12 22"></path>
                <path d="M12 2 A10 10 0 0 1 12 22" fill="currentColor" opacity="0.5"></path>
              </svg>
              <span class="contrast-label">HC</span>
            </button>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark theme">
              <svg class="theme-icon theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg class="theme-icon theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>
      </header>
      
      <main class="app-main" id="main-content">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-content">
            <h2>Get Started</h2>
            <p>Upload an OpenSCAD (.scad) file to customize its parameters and generate STL files</p>
            
            <label class="upload-zone" id="uploadZone" for="fileInput" tabindex="0">
              <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span class="upload-text">Drop .scad or .zip file here or click to browse</span>
              <input type="file" id="fileInput" accept=".scad,.zip" class="file-input" />
            </label>
            
            <div class="features-overview" role="region" aria-labelledby="features-heading">
              <h3 id="features-heading">Discover Features for Your Needs</h3>
              <p class="features-intro">Choose a path to explore accessible customization features:</p>
              
              <div class="role-paths-grid">
                <!-- Educators / Facilitators (MOVED TO FIRST) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Educators / Facilitators</h4>
                  <p class="role-path-description">Demonstrate 3D design concepts quickly with ready-to-use examples</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Change Width/Height ‚Üí watch Preview update</li>
                    <li>Save presets for classroom reuse</li>
                    <li>Guide students through full workflow (~2 min)</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="simple-box" data-role="educators" data-tutorial="educators">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-feature-tab="presets" aria-label="Open Features Guide: Presets">
                      Learn More
                    </button>
                  </div>
                </div>

                <!-- Advanced Makers (MOVED TO SECOND) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Advanced Makers</h4>
                  <p class="role-path-description">Work with multi-file projects, libraries, and advanced OpenSCAD features</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Upload ZIP files with dependencies</li>
                    <li>Enable MCAD, BOSL2, and other libraries</li>
                    <li>Export in multiple formats (STL, OBJ, 3MF)</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="library-test" data-role="makers" data-tutorial="makers">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-feature-tab="libraries" aria-label="Open Features Guide: Libraries">
                      Learn More
                    </button>
                  </div>
                </div>

                <!-- Keyboard-Only / Switch Users (MOVED TO THIRD) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Keyboard-Only Users</h4>
                  <p class="role-path-description">Complete the full workflow without a mouse using predictable keyboard controls</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Tab through parameters logically</li>
                    <li>Undo/Redo with Ctrl+Z / Ctrl+Shift+Z</li>
                    <li>Skip to main content (screen top)</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="cylinder" data-role="keyboard-only" data-tutorial="keyboard-only">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-doc="KEYGUARD_WORKFLOW_GUIDE" aria-label="Learn about keyboard navigation">
                      Learn More
                    </button>
                  </div>
                </div>

                <!-- Low Vision / High Contrast Users (MOVED TO FOURTH) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Low Vision Users</h4>
                  <p class="role-path-description">Use high contrast themes, large touch targets, and visible focus indicators</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Toggle HC button (high contrast mode)</li>
                    <li>Switch light/dark theme</li>
                    <li>All buttons meet 44√ó44px touch target</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="simple-box" data-role="low-vision" data-tutorial="low-vision">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-doc="ACCESSIBILITY_GUIDE" aria-label="Learn about visual accessibility features">
                      Learn More
                    </button>
                  </div>
                </div>

                <!-- Voice Input Users (MOVED TO FIFTH) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Voice Input Users</h4>
                  <p class="role-path-description">Control the app with voice commands using stable, speakable names</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Say button labels: "Click Generate STL"</li>
                    <li>Navigate: "Click Help", "Click Reset"</li>
                    <li>All controls have unique, speakable names</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="simple-box" data-role="voice-input" data-tutorial="voice-input">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-doc="ACCESSIBILITY_GUIDE" aria-label="Learn about voice input and accessible control names">
                      Learn More
                    </button>
                  </div>
                </div>

                <!-- Screen Reader / Blind Users (MOVED TO LAST) -->
                <div class="role-path-card">
                  <h4 class="role-path-title">Screen Reader Users</h4>
                  <p class="role-path-description">Customize models with clear status announcements and keyboard-only workflow</p>
                  <ul class="role-path-tips" aria-label="What you'll learn">
                    <li>Status area announces all changes</li>
                    <li>ARIA landmarks for quick navigation</li>
                    <li>Plain-language error messages</li>
                  </ul>
                  <div class="role-path-actions">
                    <button class="btn btn-primary btn-role-try" data-example="simple-box" data-role="screen-reader" data-tutorial="screen-reader">
                      Start Tutorial
                    </button>
                    <button class="btn btn-link btn-role-learn" data-doc="ACCESSIBILITY_GUIDE" aria-label="Learn about screen reader accessibility features">
                      Learn More
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Accessibility Spotlights -->
              <div class="accessibility-spotlights">
                <h4 class="spotlights-heading">Accessibility Highlights</h4>
                <ul class="spotlights-list">
                  <li>
                    <a href="#" class="spotlight-link" data-doc="ACCESSIBILITY_GUIDE">
                      Keyboard-first design with logical tab order
                    </a>
                  </li>
                  <li>
                    <a href="#" class="spotlight-link" data-doc="ACCESSIBILITY_GUIDE">
                      High contrast &amp; forced colors support
                    </a>
                  </li>
                  <li>
                    <a href="#" class="spotlight-link" data-doc="ACCESSIBILITY_GUIDE">
                      Plain-language error messages
                    </a>
                  </li>
                  <li>
                    <a href="#" class="spotlight-link" data-doc="KEYGUARD_WORKFLOW_GUIDE">
                      Full workflow without drag gestures
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div class="main-interface hidden" id="mainInterface">
          <div class="param-panel" id="paramPanel" role="region" aria-label="Model parameters">
            <!-- WCAG 2.2 SC 3.2.6 Consistent Help: Help mechanisms (Features Guide button) 
                 appear in consistent relative order across panels (top-right area) -->
            <div class="panel-header">
              <h2 id="parameters-heading">Parameters</h2>
              <div class="param-header-actions">
                <button id="collapseParamPanelBtn" class="btn btn-sm btn-icon" aria-expanded="true" aria-controls="paramPanelBody" aria-label="Collapse parameters" title="Collapse parameters">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <button id="undoBtn" class="btn btn-sm btn-outline" aria-label="Undo last parameter change (Ctrl+Z)" title="Undo (Ctrl+Z)" disabled>
                  ‚Ü©Ô∏è Undo
                </button>
                <button id="redoBtn" class="btn btn-sm btn-outline" aria-label="Redo parameter change (Ctrl+Shift+Z)" title="Redo (Ctrl+Shift+Z)" disabled>
                  ‚Ü™Ô∏è Redo
                </button>
                <button id="resetBtn" class="btn btn-sm" aria-label="Reset all parameters to default values">Reset</button>
              </div>
            </div>
            
            <div class="param-panel-body" id="paramPanelBody">
            <!-- Preset Controls (Collapsed by default on desktop) -->
            <details class="preset-controls" id="presetControls" role="region" aria-label="Parameter presets">
              <summary class="preset-summary">
                <span class="preset-icon">üíæ</span>
                Presets
              </summary>
              <div class="preset-content">
                <div class="preset-actions">
                  <button id="savePresetBtn" class="btn btn-sm btn-outline" aria-label="Save current parameters as preset" title="Save current parameters">
                    üíæ Save Preset
                  </button>
                  <button id="managePresetsBtn" class="btn btn-sm btn-outline" aria-label="Manage presets" title="Manage saved presets">
                    üìã Manage
                  </button>
                </div>
                <div class="preset-selector" id="presetSelector">
                  <label for="presetSelect" class="preset-label">Load Preset:</label>
                  <select id="presetSelect" class="preset-select" aria-label="Select a saved preset to load">
                    <option value="">-- Select Preset --</option>
                  </select>
                </div>
              </div>
            </details>
            
            <!-- Library Controls -->
            <div class="library-controls hidden" id="libraryControls" role="region" aria-label="OpenSCAD library bundles">
              <details class="library-details">
                <summary class="library-summary">
                  üìö Libraries <span class="library-badge" id="libraryBadge">0</span>
                </summary>
                <div class="library-content">
                  <p class="library-help">Enable libraries used by this model:</p>
                  <div class="library-list" id="libraryList">
                    <!-- Library checkboxes will be dynamically generated here -->
                  </div>
                  <div class="library-footer">
                    <button id="libraryHelpBtn" class="btn-link" aria-label="Learn more about libraries">
                      ‚ÑπÔ∏è What are libraries?
                    </button>
                  </div>
                </div>
              </details>
            </div>
            
            <!-- Feature Hints -->
            <div class="feature-hints hidden" id="featureHints" role="region" aria-label="Feature tips">
              <details class="hints-details">
                <summary class="hints-summary">
                  <span class="hints-icon" aria-hidden="true">üí°</span>
                  Tips: Enhance your model
                </summary>
                <div class="hints-content">
                  <ul class="hints-list" role="list" id="hintsList">
                    <!-- Hints dynamically populated -->
                  </ul>
                </div>
              </details>
            </div>
            
            <!-- Parameter Search and Navigation (C2: Cognitive load reduction) -->
            <div class="param-search-section" id="paramSearchSection">
              <div class="param-search-row">
                <div class="param-search-input-wrapper">
                  <label for="paramSearchInput" class="sr-only">Search parameters</label>
                  <input type="search" id="paramSearchInput" class="param-search-input" placeholder="Search parameters..." aria-label="Search parameters by name or description" autocomplete="off" />
                  <button type="button" id="clearParamSearchBtn" class="param-search-clear hidden" aria-label="Clear search">√ó</button>
                </div>
                <div class="param-jump-wrapper">
                  <label for="paramJumpSelect" class="sr-only">Jump to group</label>
                  <select id="paramJumpSelect" class="param-jump-select" aria-label="Jump to parameter group">
                    <option value="">Jump to group...</option>
                  </select>
                </div>
              </div>
              <div class="param-filter-stats hidden" id="paramFilterStats" aria-live="polite">
                <span id="paramFilterCount">0</span> parameters shown
                <button type="button" id="showAllParamsBtn" class="btn-link">Show all</button>
              </div>
            </div>
            
            <div id="parametersContainer" class="parameters-container" aria-labelledby="parameters-heading">
              <!-- Parameters will be dynamically generated here -->
            </div>
            
            <!-- Output Format Selector -->
            <div class="output-format-section" aria-label="Output format selection">
              <label for="outputFormat" class="output-format-label">Output:</label>
              <select id="outputFormat" class="output-format-select" aria-label="Select output file format">
                <option value="stl" selected>STL</option>
                <option value="obj">OBJ</option>
                <option value="off">OFF</option>
                <option value="amf">AMF</option>
                <option value="3mf">3MF</option>
              </select>
              <span class="output-format-info" id="formatInfo" aria-live="polite">
                Most common format for 3D printing
              </span>
            </div>
            
            <!-- Advanced Menu -->
            <details class="advanced-menu" id="advancedMenu">
              <summary class="advanced-menu-summary">
                <span class="advanced-icon">‚öôÔ∏è</span>
                Advanced
              </summary>
              <div class="advanced-menu-content">
                <!-- View SCAD Source -->
                <div class="advanced-section">
                  <button id="viewSourceBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="View OpenSCAD source code">
                    üìÑ View Source
                  </button>
                  <button id="copySourceBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="Copy source code to clipboard">
                    üìã Copy Source
                  </button>
                </div>
                
                <!-- Parameter Limits Override -->
                <div class="advanced-section">
                  <label class="advanced-toggle">
                    <input type="checkbox" id="unlockLimitsToggle" />
                    <span>üîì Unlock Parameter Limits</span>
                  </label>
                  <p class="advanced-hint">Allow values outside parsed min/max ranges</p>
                </div>
                
                <!-- Reset Tools -->
                <div class="advanced-section">
                  <h4 class="advanced-section-title">Reset Tools</h4>
                  <div class="reset-tools">
                    <button id="resetAllBtn" class="btn btn-sm btn-outline" aria-label="Reset all parameters to defaults">
                      ‚Ü©Ô∏è Reset All
                    </button>
                    <button id="resetGroupBtn" class="btn btn-sm btn-outline" aria-label="Reset current group to defaults">
                      üìÅ Reset Group
                    </button>
                  </div>
                  <div class="reset-group-selector hidden" id="resetGroupSelector">
                    <label for="resetGroupSelect">Select group:</label>
                    <select id="resetGroupSelect" class="reset-group-select">
                      <!-- Groups will be populated dynamically -->
                    </select>
                    <button id="confirmResetGroupBtn" class="btn btn-sm btn-primary">Reset</button>
                  </div>
                </div>
                
                <!-- Raw Parameter JSON -->
                <div class="advanced-section">
                  <button id="viewParamsJsonBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="View current parameters as JSON">
                    { } View Params JSON
                  </button>
                </div>
              </div>
            </details>
            </div>
          </div>
          
          <div class="preview-panel" id="previewPanel" role="region" aria-label="3D preview and actions">
            <div class="panel-header">
              <div class="panel-header-left">
                <h2 id="preview-heading">Preview</h2>
              </div>
              <div class="panel-header-right">
                <button id="focusModeBtn" class="btn btn-sm btn-icon hidden" aria-pressed="false" aria-label="Enter focus mode" title="Focus mode (maximize preview)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                  </svg>
                </button>
              </div>
              <div class="file-info-wrapper">
                <div class="file-info" id="fileInfo" aria-live="polite">
                  <span class="file-info-summary" id="fileInfoSummary"></span>
                  <details class="file-info-details hidden" id="fileInfoDetails">
                    <summary>Show included files</summary>
                    <div class="file-info-tree" id="fileInfoTree"></div>
                  </details>
                </div>
                <button id="featuresGuideBtn" class="btn btn-sm btn-outline hidden" aria-label="Open features guide and examples" title="Help & Examples">
                  üìñ Help
                </button>
                <button id="clearFileBtn" class="btn btn-sm btn-outline hidden" aria-label="Clear file and return to welcome screen" title="Clear file">
                  ‚úï Clear
                </button>
              </div>
            </div>
            
            <!-- Scrollable content wrapper with vertical split -->
            <div class="preview-content" id="previewContent">
              <!-- Top section: 3D preview canvas -->
              <div class="preview-canvas-section" id="previewCanvasSection">
                <div class="preview-container" id="previewContainer" role="group" aria-label="3D model preview and controls" aria-describedby="previewModelSummary" tabindex="0">
                  <!-- 3D preview or placeholder -->
                  <div class="preview-placeholder">
                    <p>3D preview will appear here after generating STL</p>
                  </div>
                  <!-- Screen reader accessible model summary (WCAG 2.2 non-visual content) -->
                  <div id="previewModelSummary" class="sr-only" aria-live="polite" aria-atomic="true">No model loaded. Upload an OpenSCAD file and generate an STL to see the 3D preview.</div>
                </div>
              </div>
              
              <!-- Bottom section: status, settings, stats, dimensions -->
              <div class="preview-info-section" id="previewInfoSection">
                <div class="status-area" id="statusArea" role="region" aria-label="Status">
                  Ready
                </div>
                <!-- Dedicated screen reader announcer (separate from visible status) -->
                <div id="srAnnouncer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

                <details class="preview-settings-details">
                  <summary class="preview-settings-summary">
                    <span class="settings-icon">‚öôÔ∏è</span>
                    Preview Settings
                  </summary>
                  <div class="preview-settings" aria-label="Preview settings">
                    <label class="preview-setting">
                      <input type="checkbox" id="autoPreviewToggle" checked />
                      <span>Auto-preview</span>
                    </label>
                    
                    <label class="preview-setting">
                      <input type="checkbox" id="measurementsToggle" aria-describedby="measurementsHelp" />
                      <span>Show measurements</span>
                    </label>
                    <span id="measurementsHelp" class="sr-only">Toggle dimension measurements and bounding box overlay on 3D preview</span>

                    <label class="preview-setting">
                      <input type="checkbox" id="gridToggle" checked aria-describedby="gridHelp" />
                      <span>Show grid</span>
                    </label>
                    <span id="gridHelp" class="sr-only">Toggle grid plane visibility in 3D preview</span>

                    <label class="preview-setting" for="previewQualitySelect">
                      <span class="preview-setting-label">Preview quality</span>
                      <select id="previewQualitySelect" aria-label="Select preview quality">
                        <option value="auto" selected>Auto (adaptive)</option>
                        <option value="fidelity">Fidelity (slower)</option>
                        <option value="balanced">Balanced</option>
                        <option value="fast">Fast (lower resolution)</option>
                      </select>
                    </label>

                    <label class="preview-setting" for="exportQualitySelect">
                      <span class="preview-setting-label">Export quality</span>
                      <select id="exportQualitySelect" aria-label="Select export quality">
                        <option value="model" selected>Model default</option>
                        <option value="low">Low (fast)</option>
                        <option value="medium">Medium (balanced)</option>
                        <option value="high">High (smooth)</option>
                      </select>
                    </label>
                    
                    <div class="preview-setting complexity-indicator" id="complexityIndicator" title="Detected model complexity tier">
                      <span class="preview-setting-label">Complexity:</span>
                      <span id="complexityTierLabel" class="complexity-tier-label">Analyzing...</span>
                    </div>

                    <div class="preview-setting model-color-setting">
                      <span class="preview-setting-label">Model Color</span>
                      <div class="model-color-picker">
                        <input type="color" id="modelColorPicker" value="#2196F3" aria-label="Choose model display color" />
                        <button id="modelColorReset" class="btn-icon" title="Reset to theme default" aria-label="Reset color to theme default">‚Ü∫</button>
                      </div>
                    </div>
                  </div>
                </details>
                
                <div class="stats" id="stats" role="status" aria-live="polite"></div>
                
                <div class="dimensions-display hidden" id="dimensionsDisplay" role="region" aria-label="Model dimensions">
                  <h3 class="dimensions-heading">Dimensions</h3>
                  <dl class="dimensions-list">
                    <div class="dimension-item">
                      <dt>Width (X):</dt>
                      <dd id="dimX">--</dd>
                    </div>
                    <div class="dimension-item">
                      <dt>Depth (Y):</dt>
                      <dd id="dimY">--</dd>
                    </div>
                    <div class="dimension-item">
                      <dt>Height (Z):</dt>
                      <dd id="dimZ">--</dd>
                    </div>
                    <div class="dimension-item">
                      <dt>Volume:</dt>
                      <dd id="dimVolume">--</dd>
                    </div>
                  </dl>
                </div>
              </div>
            </div>
            
            <!-- Actions bar - sticky at bottom -->
            <div class="actions">
              <button id="primaryActionBtn" class="btn btn-primary btn-large" aria-label="Generate STL file from current parameters" data-action="generate">Generate STL</button>
              <button id="cancelRenderBtn" class="btn btn-outline hidden" aria-label="Cancel current render operation">‚èπÔ∏è Cancel</button>
              <a id="downloadFallbackLink" href="#" class="btn btn-sm btn-outline hidden" aria-label="Download previously generated file">üì• Download last file</a>
              <button id="addToComparisonBtn" class="btn btn-secondary" aria-label="Add current configuration to comparison">‚öñÔ∏è Compare</button>
              <details class="actions-more">
                <summary class="btn btn-secondary" aria-label="Show more actions">‚ãØ More</summary>
                <div class="actions-more-content">
                  <button id="addToQueueBtn" class="btn btn-secondary" aria-label="Add current configuration to render queue">üìã Add to Queue</button>
                  <button id="viewQueueBtn" class="btn btn-secondary" aria-label="View and manage render queue">üîÑ Queue <span class="queue-badge" id="queueBadge">0</span></button>
                  <button id="shareBtn" class="btn btn-secondary" aria-label="Copy shareable link with current parameters">üìã Copy Share Link</button>
                  <button id="exportParamsBtn" class="btn btn-secondary" aria-label="Download parameters as JSON file">üíæ Export Params</button>
                </div>
              </details>
            </div>
          </div>
        </div>
        
        <!-- Comparison View (hidden by default) -->
        <div class="comparison-view hidden" id="comparisonView" role="region" aria-label="Comparison view">
          <!-- Comparison UI will be dynamically generated here -->
        </div>
      </main>
      
      <div class="error-message hidden" id="errorMessage" role="alert" aria-live="assertive" aria-atomic="true"></div>
      
      <!-- Workflow Progress Indicator (C3: COGA breadcrumbs) -->
      <div class="workflow-progress hidden" id="workflowProgress" role="navigation" aria-label="Workflow progress">
        <ol class="workflow-steps">
          <li class="workflow-step" data-step="upload" aria-current="false">
            <span class="workflow-step-number">1</span>
            <span class="workflow-step-label">Upload</span>
          </li>
          <li class="workflow-step" data-step="customize" aria-current="false">
            <span class="workflow-step-number">2</span>
            <span class="workflow-step-label">Customize</span>
          </li>
          <li class="workflow-step" data-step="render" aria-current="false">
            <span class="workflow-step-number">3</span>
            <span class="workflow-step-label">Generate</span>
          </li>
          <li class="workflow-step" data-step="download" aria-current="false">
            <span class="workflow-step-number">4</span>
            <span class="workflow-step-label">Download</span>
          </li>
        </ol>
      </div>
    </div>
    
    <!-- Render Queue Modal -->
    <div class="modal hidden" id="renderQueueModal" role="dialog" aria-labelledby="queueModalTitle" aria-modal="true">
      <div class="modal-overlay" id="queueModalOverlay"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2 id="queueModalTitle">Render Queue</h2>
          <button class="modal-close" id="queueModalClose" aria-label="Close render queue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body" id="queueModalBody">
          <!-- Queue controls -->
          <div class="queue-controls">
            <button id="processQueueBtn" class="btn btn-primary" aria-label="Process all queued jobs">
              ‚ñ∂Ô∏è Process Queue
            </button>
            <button id="stopQueueBtn" class="btn btn-outline hidden" aria-label="Stop processing queue">
              ‚è∏Ô∏è Stop
            </button>
            <button id="clearCompletedBtn" class="btn btn-outline" aria-label="Clear completed jobs">
              üóëÔ∏è Clear Completed
            </button>
            <button id="clearQueueBtn" class="btn btn-outline" aria-label="Clear all jobs">
              üóëÔ∏è Clear All
            </button>
            <button id="exportQueueBtn" class="btn btn-outline" aria-label="Export queue as JSON">
              üíæ Export Queue
            </button>
            <button id="importQueueBtn" class="btn btn-outline" aria-label="Import queue from JSON">
              üìÇ Import Queue
            </button>
          </div>
          
          <!-- Queue statistics -->
          <div class="queue-stats" id="queueStats" aria-live="polite">
            <span class="queue-stat">Total: <strong id="queueStatsTotal">0</strong></span>
            <span class="queue-stat">Queued: <strong id="queueStatsQueued">0</strong></span>
            <span class="queue-stat">Rendering: <strong id="queueStatsRendering">0</strong></span>
            <span class="queue-stat">Complete: <strong id="queueStatsComplete">0</strong></span>
            <span class="queue-stat">Error: <strong id="queueStatsError">0</strong></span>
          </div>
          
          <!-- Queue list -->
          <div class="queue-list" id="queueList" role="list">
            <!-- Queue items will be dynamically generated here -->
            <div class="queue-empty" id="queueEmpty" role="listitem">
              <p>No jobs in queue</p>
              <p class="queue-empty-hint">Click "Add to Queue" to add jobs</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hidden file input for queue import -->
    <input type="file" id="queueImportInput" accept=".json" style="display: none;" aria-hidden="true" />
    
    <!-- Source Code Viewer Modal -->
    <div class="modal hidden" id="sourceViewerModal" role="dialog" aria-labelledby="sourceViewerTitle" aria-modal="true">
      <div class="modal-overlay" id="sourceViewerOverlay"></div>
      <div class="modal-content modal-large modal-source">
        <div class="modal-header">
          <h2 id="sourceViewerTitle">OpenSCAD Source</h2>
          <div class="source-viewer-actions">
            <button class="btn btn-sm btn-outline" id="sourceViewerCopy" aria-label="Copy source code">
              üìã Copy
            </button>
            <button class="modal-close" id="sourceViewerClose" aria-label="Close source viewer">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body source-viewer-body">
          <textarea id="sourceViewerContent" class="source-viewer-textarea" readonly aria-label="OpenSCAD source code" spellcheck="false"></textarea>
          <div class="source-viewer-info" id="sourceViewerInfo">
            <!-- File info will be displayed here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Parameters JSON Viewer Modal -->
    <div class="modal hidden" id="paramsJsonModal" role="dialog" aria-labelledby="paramsJsonTitle" aria-modal="true">
      <div class="modal-overlay" id="paramsJsonOverlay"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h2 id="paramsJsonTitle">Current Parameters (JSON)</h2>
          <div class="params-json-actions">
            <button class="btn btn-sm btn-outline" id="paramsJsonCopy" aria-label="Copy parameters JSON">
              üìã Copy
            </button>
            <button class="modal-close" id="paramsJsonClose" aria-label="Close parameters viewer">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body">
          <textarea id="paramsJsonContent" class="params-json-textarea" readonly aria-label="Parameters JSON" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Features Guide Modal -->
    <div class="modal hidden" id="featuresGuideModal" role="dialog" aria-labelledby="featuresGuideTitle" aria-modal="true">
      <div class="modal-overlay" id="featuresGuideOverlay"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2 id="featuresGuideTitle">Features Guide</h2>
          <button class="modal-close" id="featuresGuideClose" aria-label="Close features guide">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body features-guide-body">
          <!-- Tab navigation for feature sections -->
          <div class="features-tabs" role="tablist" aria-label="Feature sections">
            <button class="features-tab" role="tab" aria-selected="true" aria-controls="featuresPanelLibraries" id="tab-libraries" tabindex="0">Libraries</button>
            <button class="features-tab" role="tab" aria-selected="false" aria-controls="featuresPanelColors" id="tab-colors" tabindex="-1">Color Parameters</button>
            <button class="features-tab" role="tab" aria-selected="false" aria-controls="featuresPanelPresets" id="tab-presets" tabindex="-1">Presets</button>
            <button class="features-tab" role="tab" aria-selected="false" aria-controls="featuresPanelAdvanced" id="tab-advanced" tabindex="-1">Advanced</button>
          </div>
          
          <!-- Libraries Panel -->
          <div class="features-panel" id="featuresPanelLibraries" role="tabpanel" tabindex="0" aria-labelledby="tab-libraries">
            <h3>OpenSCAD Library Bundles</h3>
            <p>This customizer includes popular OpenSCAD library bundles that provide reusable components and advanced functions for your models.</p>
            
            <h4>Available Libraries</h4>
            <ul class="features-list">
              <li><strong>MCAD</strong> ‚Äì Mechanical components like gears, screws, bearings, and fasteners</li>
              <li><strong>BOSL2</strong> ‚Äì Advanced geometry primitives, attachable parts, and complex shapes</li>
              <li><strong>NopSCADlib</strong> ‚Äì Parts library for 3D printers and electronics projects</li>
              <li><strong>dotSCAD</strong> ‚Äì Artistic patterns, designs, and creative geometry</li>
            </ul>
            
            <h4>How to Use Libraries</h4>
            <p>Include library modules in your OpenSCAD code:</p>
            <pre><code>use &lt;MCAD/boxes.scad&gt;;
use &lt;BOSL2/std.scad&gt;;</code></pre>
            
            <p>The customizer automatically detects which libraries your model uses and marks them as "required". You can also manually enable any library from the üìö Libraries panel.</p>
            
            <div class="features-action">
              <button class="btn btn-primary" data-example="library-test" data-feature-example="true">
                üìö Load Library Test Example
              </button>
              <p class="features-note">This example demonstrates MCAD library usage with mechanical components.</p>
            </div>
          </div>
          
          <!-- Colors Panel -->
          <div class="features-panel" id="featuresPanelColors" role="tabpanel" tabindex="0" aria-labelledby="tab-colors" hidden>
            <h3>Color Parameters</h3>
            <p>Add interactive color pickers to your models by using the <code>[color]</code> annotation in your OpenSCAD parameters.</p>
            
            <h4>Syntax</h4>
            <pre><code>// Hex color with annotation
box_color = "FF6B35"; // [color]

// RGB hex format (with or without #)
primary_color = "#3498DB"; // [color]
secondary_color = "E74C3C"; // [color]</code></pre>
            
            <h4>How It Works</h4>
            <p>When you add the <code>// [color]</code> annotation to a string parameter, the customizer:</p>
            <ul class="features-list">
              <li>Displays a visual color picker instead of a text input</li>
              <li>Shows a color preview swatch next to the parameter</li>
              <li>Validates hex color values automatically</li>
              <li>Updates the preview in real-time as you change colors</li>
            </ul>
            
            <h4>Using Colors in Your Model</h4>
            <p>Convert hex strings to RGB values in OpenSCAD:</p>
            <pre><code>function hex2rgb(hex) = [
  (search(substr(hex,0,2), "0123456789ABCDEF") / 16) / 255,
  (search(substr(hex,2,2), "0123456789ABCDEF") / 16) / 255,
  (search(substr(hex,4,2), "0123456789ABCDEF") / 16) / 255
];

color(hex2rgb(box_color))
  cube([10, 10, 10]);</code></pre>
            
            <div class="features-action">
              <button class="btn btn-primary" data-example="colored-box" data-feature-example="true">
                üé® Load Colored Box Example
              </button>
              <p class="features-note">This example shows how to use color parameters with a complete hex2rgb implementation.</p>
            </div>
          </div>
          
          <!-- Presets Panel -->
          <div class="features-panel" id="featuresPanelPresets" role="tabpanel" tabindex="0" aria-labelledby="tab-presets" hidden>
            <h3>Parameter Presets</h3>
            <p>Save and load your favorite parameter configurations to quickly switch between different variations of your model.</p>
            
            <h4>Saving Presets</h4>
            <ol class="features-list">
              <li>Adjust your parameters to the desired values</li>
              <li>Click the <strong>üíæ Save Preset</strong> button above the parameters</li>
              <li>Enter a descriptive name for your preset</li>
              <li>Your preset is saved locally in your browser</li>
            </ol>
            
            <h4>Loading Presets</h4>
            <p>Use the preset dropdown menu to quickly switch between saved configurations. The parameters will update automatically.</p>
            
            <h4>Managing Presets</h4>
            <ul class="features-list">
              <li><strong>Rename</strong> ‚Äì Update preset names for clarity</li>
              <li><strong>Delete</strong> ‚Äì Remove presets you no longer need</li>
              <li><strong>Export/Import</strong> ‚Äì Share presets with others or back them up</li>
            </ul>
            
            <p>Presets are stored per-file, so each model has its own set of saved configurations.</p>
          </div>
          
          <!-- Advanced Panel -->
          <div class="features-panel" id="featuresPanelAdvanced" role="tabpanel" tabindex="0" aria-labelledby="tab-advanced" hidden>
            <h3>Advanced Features</h3>
            
            <h4>Output Formats</h4>
            <p>Export your customized models in multiple formats:</p>
            <ul class="features-list">
              <li><strong>STL</strong> ‚Äì Standard format for 3D printing (binary or ASCII)</li>
              <li><strong>OBJ</strong> ‚Äì Common 3D model format with material support</li>
              <li><strong>OFF</strong> ‚Äì Object File Format for geometry</li>
              <li><strong>AMF</strong> ‚Äì Additive Manufacturing File Format</li>
              <li><strong>3MF</strong> ‚Äì Modern 3D printing format with color support</li>
            </ul>
            
            <h4>Multi-File Projects</h4>
            <p>Upload ZIP files containing multiple OpenSCAD files. The customizer will:</p>
            <ul class="features-list">
              <li>Automatically detect the main file</li>
              <li>Extract and mount all included files</li>
              <li>Display a file tree showing the project structure</li>
              <li>Support relative paths in <code>include</code> and <code>use</code> statements</li>
            </ul>
            
            <h4>Parameter Limits Override</h4>
            <p>By default, sliders and number inputs respect the limits defined in your OpenSCAD file. You can unlock parameter limits from the Advanced menu to enter custom values.</p>
            
            <h4>Source Code Viewer</h4>
            <p>View the complete OpenSCAD source code, including all included files, from the Advanced menu. This helps verify that multi-file projects are loaded correctly.</p>
            
            <h4>Render Quality</h4>
            <p>Choose different quality levels for preview rendering:</p>
            <ul class="features-list">
              <li><strong>Draft</strong> ‚Äì Fast rendering for quick iterations</li>
              <li><strong>Normal</strong> ‚Äì Balanced quality and speed (default)</li>
              <li><strong>High</strong> ‚Äì Higher detail for final previews</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Reset All Confirmation Modal (COGA: Undo confirmation) -->
    <div class="modal hidden" id="resetConfirmModal" role="dialog" aria-labelledby="resetConfirmTitle" aria-modal="true">
      <div class="modal-overlay" id="resetConfirmOverlay"></div>
      <div class="modal-content modal-small confirm-modal-content">
        <div class="modal-header">
          <h2 id="resetConfirmTitle">Reset All Parameters?</h2>
          <button class="modal-close" id="resetConfirmClose" aria-label="Cancel reset">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body confirm-modal-body">
          <p>This will reset <strong id="resetParamCount">all</strong> parameters to their original default values.</p>
          <p class="confirm-warning">Any customizations you've made will be lost.</p>
        </div>
        <div class="modal-footer confirm-modal-footer">
          <button id="resetConfirmCancel" class="btn btn-secondary">Cancel</button>
          <button id="resetConfirmOk" class="btn btn-primary">Reset All</button>
        </div>
      </div>
    </div>
    
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
