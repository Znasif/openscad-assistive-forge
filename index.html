<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Web-based OpenSCAD customizer - customize and generate 3D printable STL files directly in your browser" />
    <title>OpenSCAD Web Customizer</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Theme colors -->
    <meta name="theme-color" content="#0066cc" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    
    <!-- Apple Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="OpenSCAD Forge" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png" />
    
    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#0066cc" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
  </head>
  <body>
    <!-- Skip to content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="app" role="application" aria-label="OpenSCAD Web Customizer">
      <header class="app-header">
        <div class="header-content">
          <div class="header-branding">
            <h1>OpenSCAD Web Customizer</h1>
            <p class="app-tagline">Customize 3D models directly in your browser</p>
          </div>
          <div class="header-controls">
            <button id="contrastToggle" class="contrast-toggle" aria-label="Toggle high contrast" title="Toggle high contrast mode">
              <svg class="contrast-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2 L12 22"></path>
                <path d="M12 2 A10 10 0 0 1 12 22" fill="currentColor" opacity="0.5"></path>
              </svg>
              <span class="contrast-label">HC</span>
            </button>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark theme">
              <svg class="theme-icon theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg class="theme-icon theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>
      </header>
      
      <main class="app-main" id="main-content">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-content">
            <h2>Get Started</h2>
            <p>Upload an OpenSCAD (.scad) file to customize its parameters and generate STL files</p>
            
            <label class="upload-zone" id="uploadZone" for="fileInput">
              <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span class="upload-text">Drop .scad or .zip file here or click to browse</span>
              <input type="file" id="fileInput" accept=".scad,.zip" class="file-input" />
            </label>
            
            <div class="examples-section">
              <p>Or try an example:</p>
              <div class="example-buttons">
                <button id="loadUniversalCuffBtn" class="btn btn-secondary" data-example="universal-cuff">Universal Cuff (Complex)</button>
                <button id="loadSimpleBoxBtn" class="btn btn-secondary" data-example="simple-box">Simple Box (Beginner)</button>
                <button id="loadCylinderBtn" class="btn btn-secondary" data-example="cylinder">Parametric Cylinder</button>
                <button id="loadLibraryTestBtn" class="btn btn-secondary" data-example="library-test">üìö Library Test (MCAD)</button>
                <button id="loadColoredBoxBtn" class="btn btn-secondary" data-example="colored-box">üé® Colored Box (Color Params)</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="main-interface hidden" id="mainInterface">
          <div class="param-panel" role="region" aria-label="Model parameters">
            <div class="panel-header">
              <h2 id="parameters-heading">Parameters</h2>
              <div class="param-header-actions">
                <button id="undoBtn" class="btn btn-sm btn-outline" aria-label="Undo last parameter change (Ctrl+Z)" title="Undo (Ctrl+Z)" disabled>
                  ‚Ü©Ô∏è Undo
                </button>
                <button id="redoBtn" class="btn btn-sm btn-outline" aria-label="Redo parameter change (Ctrl+Shift+Z)" title="Redo (Ctrl+Shift+Z)" disabled>
                  ‚Ü™Ô∏è Redo
                </button>
                <button id="resetBtn" class="btn btn-sm" aria-label="Reset all parameters to default values">Reset</button>
              </div>
            </div>
            
            <!-- Preset Controls -->
            <div class="preset-controls" id="presetControls" role="region" aria-label="Parameter presets">
              <div class="preset-actions">
                <button id="savePresetBtn" class="btn btn-sm btn-outline" aria-label="Save current parameters as preset" title="Save current parameters">
                  üíæ Save Preset
                </button>
                <button id="managePresetsBtn" class="btn btn-sm btn-outline" aria-label="Manage presets" title="Manage saved presets">
                  üìã Manage
                </button>
              </div>
              <div class="preset-selector" id="presetSelector">
                <label for="presetSelect" class="preset-label">Load Preset:</label>
                <select id="presetSelect" class="preset-select" aria-label="Select a saved preset to load">
                  <option value="">-- Select Preset --</option>
                </select>
              </div>
            </div>
            
            <!-- Library Controls -->
            <div class="library-controls hidden" id="libraryControls" role="region" aria-label="OpenSCAD library bundles">
              <details class="library-details">
                <summary class="library-summary">
                  üìö Libraries <span class="library-badge" id="libraryBadge">0</span>
                </summary>
                <div class="library-content">
                  <p class="library-help">Enable libraries used by this model:</p>
                  <div class="library-list" id="libraryList">
                    <!-- Library checkboxes will be dynamically generated here -->
                  </div>
                  <div class="library-footer">
                    <button id="libraryHelpBtn" class="btn-link" aria-label="Learn more about libraries">
                      ‚ÑπÔ∏è What are libraries?
                    </button>
                  </div>
                </div>
              </details>
            </div>
            
            <div id="parametersContainer" class="parameters-container" aria-labelledby="parameters-heading">
              <!-- Parameters will be dynamically generated here -->
            </div>
            
            <!-- Advanced Menu -->
            <details class="advanced-menu" id="advancedMenu">
              <summary class="advanced-menu-summary">
                <span class="advanced-icon">‚öôÔ∏è</span>
                Advanced
              </summary>
              <div class="advanced-menu-content">
                <!-- View SCAD Source -->
                <div class="advanced-section">
                  <button id="viewSourceBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="View OpenSCAD source code">
                    üìÑ View Source
                  </button>
                  <button id="copySourceBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="Copy source code to clipboard">
                    üìã Copy Source
                  </button>
                </div>
                
                <!-- Parameter Limits Override -->
                <div class="advanced-section">
                  <label class="advanced-toggle">
                    <input type="checkbox" id="unlockLimitsToggle" />
                    <span>üîì Unlock Parameter Limits</span>
                  </label>
                  <p class="advanced-hint">Allow values outside parsed min/max ranges</p>
                </div>
                
                <!-- Reset Tools -->
                <div class="advanced-section">
                  <h4 class="advanced-section-title">Reset Tools</h4>
                  <div class="reset-tools">
                    <button id="resetAllBtn" class="btn btn-sm btn-outline" aria-label="Reset all parameters to defaults">
                      ‚Ü©Ô∏è Reset All
                    </button>
                    <button id="resetGroupBtn" class="btn btn-sm btn-outline" aria-label="Reset current group to defaults">
                      üìÅ Reset Group
                    </button>
                  </div>
                  <div class="reset-group-selector hidden" id="resetGroupSelector">
                    <label for="resetGroupSelect">Select group:</label>
                    <select id="resetGroupSelect" class="reset-group-select">
                      <!-- Groups will be populated dynamically -->
                    </select>
                    <button id="confirmResetGroupBtn" class="btn btn-sm btn-primary">Reset</button>
                  </div>
                </div>
                
                <!-- Raw Parameter JSON -->
                <div class="advanced-section">
                  <button id="viewParamsJsonBtn" class="btn btn-sm btn-outline advanced-btn" aria-label="View current parameters as JSON">
                    { } View Params JSON
                  </button>
                </div>
              </div>
            </details>
          </div>
          
          <div class="preview-panel" role="region" aria-label="3D preview and actions">
            <div class="panel-header">
              <h2 id="preview-heading">Preview</h2>
              <div class="file-info-wrapper">
                <div class="file-info" id="fileInfo" aria-live="polite"></div>
                <button id="clearFileBtn" class="btn btn-sm btn-outline hidden" aria-label="Clear file and return to welcome screen" title="Clear file">
                  ‚úï Clear
                </button>
              </div>
            </div>
            
            <!-- Scrollable content wrapper -->
            <div class="preview-content">
              <div class="status-area" id="statusArea" role="status" aria-live="polite" aria-atomic="true">
                Ready
              </div>

              <div class="preview-settings" aria-label="Preview settings">
                <label class="preview-setting">
                  <input type="checkbox" id="autoPreviewToggle" checked />
                  <span>Auto-preview</span>
                </label>
                
                <label class="preview-setting">
                  <input type="checkbox" id="measurementsToggle" aria-describedby="measurementsHelp" />
                  <span>Show measurements</span>
                </label>
                <span id="measurementsHelp" class="sr-only">Toggle dimension measurements and bounding box overlay on 3D preview</span>

                <label class="preview-setting" for="previewQualitySelect">
                  <span class="preview-setting-label">Preview quality</span>
                  <select id="previewQualitySelect" aria-label="Select preview quality">
                    <option value="fidelity">Fidelity (slower)</option>
                    <option value="balanced" selected>Balanced</option>
                    <option value="fast">Fast (lower resolution)</option>
                  </select>
                </label>
              </div>
              
              <div class="preview-container" id="previewContainer" role="img" aria-label="3D model preview">
                <!-- 3D preview or placeholder -->
                <div class="preview-placeholder">
                  <p>3D preview will appear here after generating STL</p>
                </div>
              </div>
              
              <div class="format-selector" aria-label="Output format selection">
                <label for="outputFormat" class="format-label">Output Format:</label>
                <select id="outputFormat" class="format-select" aria-label="Select output file format">
                  <option value="stl" selected>STL (Standard)</option>
                  <option value="obj">OBJ (Wavefront)</option>
                  <option value="off">OFF (Geometry)</option>
                  <option value="amf">AMF (Additive Manufacturing)</option>
                  <option value="3mf">3MF (3D Manufacturing)</option>
                </select>
                <span class="format-info" id="formatInfo" aria-live="polite">
                  Most common format for 3D printing
                </span>
              </div>
              
              <div class="stats" id="stats" role="status" aria-live="polite"></div>
              
              <div class="dimensions-display hidden" id="dimensionsDisplay" role="region" aria-label="Model dimensions">
                <h3 class="dimensions-heading">Dimensions</h3>
                <dl class="dimensions-list">
                  <div class="dimension-item">
                    <dt>Width (X):</dt>
                    <dd id="dimX">--</dd>
                  </div>
                  <div class="dimension-item">
                    <dt>Depth (Y):</dt>
                    <dd id="dimY">--</dd>
                  </div>
                  <div class="dimension-item">
                    <dt>Height (Z):</dt>
                    <dd id="dimZ">--</dd>
                  </div>
                  <div class="dimension-item">
                    <dt>Volume:</dt>
                    <dd id="dimVolume">--</dd>
                  </div>
                </dl>
              </div>
            </div>
            
            <!-- Actions bar - sticky at bottom -->
            <div class="actions">
              <button id="primaryActionBtn" class="btn btn-primary btn-large" aria-label="Generate STL file from current parameters" data-action="generate">Generate STL</button>
              <button id="cancelRenderBtn" class="btn btn-outline hidden" aria-label="Cancel current render operation">‚èπÔ∏è Cancel</button>
              <a id="downloadFallbackLink" href="#" class="btn btn-sm btn-outline hidden" aria-label="Download previously generated file">üì• Download last file</a>
              <button id="addToComparisonBtn" class="btn btn-secondary" aria-label="Add current configuration to comparison">‚öñÔ∏è Add to Comparison</button>
              <button id="addToQueueBtn" class="btn btn-secondary" aria-label="Add current configuration to render queue">üìã Add to Queue</button>
              <button id="viewQueueBtn" class="btn btn-secondary" aria-label="View and manage render queue">üîÑ Queue <span class="queue-badge" id="queueBadge">0</span></button>
              <button id="shareBtn" class="btn btn-secondary" aria-label="Copy shareable link with current parameters">üìã Copy Share Link</button>
              <button id="exportParamsBtn" class="btn btn-secondary" aria-label="Download parameters as JSON file">üíæ Export Params (JSON)</button>
            </div>
          </div>
        </div>
        
        <!-- Comparison View (hidden by default) -->
        <div class="comparison-view hidden" id="comparisonView" role="region" aria-label="Comparison view">
          <!-- Comparison UI will be dynamically generated here -->
        </div>
      </main>
      
      <div class="error-message hidden" id="errorMessage" role="alert" aria-live="assertive" aria-atomic="true"></div>
    </div>
    
    <!-- Render Queue Modal -->
    <div class="modal hidden" id="renderQueueModal" role="dialog" aria-labelledby="queueModalTitle" aria-modal="true">
      <div class="modal-overlay" id="queueModalOverlay"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2 id="queueModalTitle">Render Queue</h2>
          <button class="modal-close" id="queueModalClose" aria-label="Close render queue">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body" id="queueModalBody">
          <!-- Queue controls -->
          <div class="queue-controls">
            <button id="processQueueBtn" class="btn btn-primary" aria-label="Process all queued jobs">
              ‚ñ∂Ô∏è Process Queue
            </button>
            <button id="stopQueueBtn" class="btn btn-outline hidden" aria-label="Stop processing queue">
              ‚è∏Ô∏è Stop
            </button>
            <button id="clearCompletedBtn" class="btn btn-outline" aria-label="Clear completed jobs">
              üóëÔ∏è Clear Completed
            </button>
            <button id="clearQueueBtn" class="btn btn-outline" aria-label="Clear all jobs">
              üóëÔ∏è Clear All
            </button>
            <button id="exportQueueBtn" class="btn btn-outline" aria-label="Export queue as JSON">
              üíæ Export Queue
            </button>
            <button id="importQueueBtn" class="btn btn-outline" aria-label="Import queue from JSON">
              üìÇ Import Queue
            </button>
          </div>
          
          <!-- Queue statistics -->
          <div class="queue-stats" id="queueStats" aria-live="polite">
            <span class="queue-stat">Total: <strong id="queueStatsTotal">0</strong></span>
            <span class="queue-stat">Queued: <strong id="queueStatsQueued">0</strong></span>
            <span class="queue-stat">Rendering: <strong id="queueStatsRendering">0</strong></span>
            <span class="queue-stat">Complete: <strong id="queueStatsComplete">0</strong></span>
            <span class="queue-stat">Error: <strong id="queueStatsError">0</strong></span>
          </div>
          
          <!-- Queue list -->
          <div class="queue-list" id="queueList" role="list">
            <!-- Queue items will be dynamically generated here -->
            <div class="queue-empty" id="queueEmpty">
              <p>No jobs in queue</p>
              <p class="queue-empty-hint">Click "Add to Queue" to add jobs</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Hidden file input for queue import -->
    <input type="file" id="queueImportInput" accept=".json" style="display: none;" aria-hidden="true" />
    
    <!-- Source Code Viewer Modal -->
    <div class="modal hidden" id="sourceViewerModal" role="dialog" aria-labelledby="sourceViewerTitle" aria-modal="true">
      <div class="modal-overlay" id="sourceViewerOverlay"></div>
      <div class="modal-content modal-large modal-source">
        <div class="modal-header">
          <h2 id="sourceViewerTitle">OpenSCAD Source</h2>
          <div class="source-viewer-actions">
            <button class="btn btn-sm btn-outline" id="sourceViewerCopy" aria-label="Copy source code">
              üìã Copy
            </button>
            <button class="modal-close" id="sourceViewerClose" aria-label="Close source viewer">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body source-viewer-body">
          <textarea id="sourceViewerContent" class="source-viewer-textarea" readonly aria-label="OpenSCAD source code" spellcheck="false"></textarea>
          <div class="source-viewer-info" id="sourceViewerInfo">
            <!-- File info will be displayed here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Parameters JSON Viewer Modal -->
    <div class="modal hidden" id="paramsJsonModal" role="dialog" aria-labelledby="paramsJsonTitle" aria-modal="true">
      <div class="modal-overlay" id="paramsJsonOverlay"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h2 id="paramsJsonTitle">Current Parameters (JSON)</h2>
          <div class="params-json-actions">
            <button class="btn btn-sm btn-outline" id="paramsJsonCopy" aria-label="Copy parameters JSON">
              üìã Copy
            </button>
            <button class="modal-close" id="paramsJsonClose" aria-label="Close parameters viewer">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body">
          <textarea id="paramsJsonContent" class="params-json-textarea" readonly aria-label="Parameters JSON" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
    
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
